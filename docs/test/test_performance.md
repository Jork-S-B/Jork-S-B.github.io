# 性能测试

性能测试，评估系统整体性能的测试，主要指标有响应时间、吞吐量、资源利用率等。

* 压力测试，在强负载（大数据量、大量并发用户等）下的测试。
* 负载测试，在一定负载情况下的系统性能测试（不关注稳定性，也就是说不关注长时间运行，只是得到不同负载下相关性能指标即可），关注被测应用可以承受多少负载。

---

## 📌 使用JMeter进行压力测试

1. 用户定义的变量，内容包括线程数8、ramp_up_time启动所有线程所需时间、循环次数、持续时间300s、启动延迟时间。
2. 登录请求线程组，搭配正则表达式提取器、BeanShell PostProcessor将token设置为全局变量。
3. Http请求默认值，包括协议、ip、端口、编码。
4. Http信息头管理器，包括报文类型、token等信息。
5. 被测请求线程组，包括事务控制器、csv数据文件（参数化）、请求、提取器、响应断言、断言结果、汇总报告。
6. 总体的结果树、报告、事务响应时间图
7. 生成html报告，平均响应时间200ms-1200ms

步骤参考: [202409.jmx](performance/202409.jmx)

执行参考: [run.sh](performance/run.sh)

参考资料: [JMeter压力测试完整流程](https://blog.csdn.net/m0_47747596/article/details/131658904)

=== "run.sh"
    
    ```shell
    #!/bin/bash
    current_datetime=$(date +%Y%m%d%H%M%S)
    mkdir -p "${current_datetime}"
    # touch "${current_datetime}/output.jtl"  # 无需先手动创建
    mkdir -p "${current_datetime}/results"
    jmeter -n -t 202409.jmx -l "${current_datetime}/output.jtl" -e -o "${current_datetime}/results"
    ```

### 🚁 仅一次控制器

控制仅使用一次的请求

### 🚁 吞吐量控制器

限制流量，吞吐量控制器-吞吐量设置为10.0，表示限流为10%。

### 🚁 事务控制器

当需要将多个请求一起统计时使用。

### 🚁 后置处理器

* 边界提取器，输入左边界/右边界，提取边界里的数据。
* 其他的还有json提取器、正则提取器、xpath提取器等。

### 🚁 并发

同步定时器，等待线程数到预设数量后触发事务，达到集合点的作用。

参考资料: [同步定时器](https://zhuanlan.zhihu.com/p/594119162?utm_id=0)

### 🚁 断言

* 响应断言，可以配置匹配响应文本、请求头、响应头等，或者设置包括、相等等规则
* 数据包字节大小断言
* 持续时间断言，判断是否在指定时间内返回响应结果
* beanshell断言

[其他功能补充](../utils/jmeter_notes.md)

## 📌 压测需要关注的指标

吞吐量、响应时间和用户数量: 刚开始吞吐量随着用户数量的增加逐渐变大，当达到一定程度时，逐渐平缓直到变成一条平线；而响应时间随着用户数量的增长逐渐变大。

关注的指标: 并发数、响应时间、TPS-每秒处理事务数、QPS-每秒处理查询数、服务器资源。

🎬 场景: 并发数太高，吞吐量小，影响得到的响应时间准确性。

需要从小并发往上递增加压，TPS随之往上增长；当TPS不涨时，此时的并发数就是最佳并发数。

---

而当在最佳并发数下出现响应时间过长的情况时:

🤔 分析原因:

* 网络延迟: 检查网络状况，确保网络带宽和稳定性满足测试需求。（局域网一般影响不大）

* 服务器性能: 检查服务器CPU、内存等资源使用情况，判断是否由于资源不足导致性能下降。

* 接口设计: 检查接口是否涉及复杂计算或大量数据处理，这些操作可能导致响应时间延长。

* 代码优化: 分析代码实现，看是否存在可以优化的地方，如减少数据库查询次数、使用缓存等。

🔎 处理方法:

* 优化网络: 如果网络延迟是主要原因，可以尝试升级网络设备、优化网络配置或选择更稳定的网络环境进行测试。

* 升级服务器: 如果服务器性能不足，可以考虑升级服务器硬件或增加服务器数量来提高处理能力。

* 优化接口设计: 对于涉及复杂计算或大量数据处理的接口，可以尝试优化算法、减少数据处理量或采用异步处理方式来提高响应速度。

* 优化代码: 对代码进行性能分析，找出性能瓶颈并进行优化。可以考虑使用更高效的算法、减少数据库查询次数、使用缓存等技术来提高响应速度。

* 引入缓存机制: 对于经常访问的数据或计算结果，可以将其缓存在内存或缓存数据库中，以减少对数据库的访问次数，提高响应速度。

* 使用分布式缓存: 将经常访问的数据缓存到内存中，以减少数据库的访问次数，提高接口的响应速度。

## 📌 分布式集群压测

单台压力机，资源不足以触发足够多的并发时，采用分布式压测。

1.配置控制机的jmeter/bin/jmeter.properties

* 搜索: `server.rmi.ssl.disable`，设置为true，不使用加密认证传输。
* 搜索: `remote_hosts`，设置压力机的ip及端口，逗号分隔。
* 搜索: `mode=Standard`，去掉注释，用于图形界面看结果。

2.打包jmeter目录及jmx脚本，上传到压力机，确保版本、配置、脚本等一致。

3.配置压力机的jmeter/bin/jmeter.properties

* 搜索: `remote_hosts`，设置为`127.0.0.1`。
* 搜索: `server_prot`，设置控制机的端口。
* 关闭防火墙: `systemctl stop firewalld.service`
* 设置可执行权限: `chmod 777 jmeter/bin`
* 启动压力机服务: `jmter-server -Djava.rmi.server.hostname={ip}`
前提: 执行机已安装JDK

4.控制机图形化界面远程启动  
运行->远程启动->选择压力机  
或者通过命令启动: `jmeter -n -t 202409.jmx -l "${current_datetime}/output.jtl" -e -o "${current_datetime}/results" -r`

## 📌 监控运行结果

### 🚁 Grafana: 可视化的图形展示平台，提供了较多模板，自动收集服务器资源。

1.安装: `sudo yum install -y https://dl.grafana.com/oss/release/grafana-10.0.3-1.x86_64.rpm`

2.启动服务: `systemctl start grafana-server`  
关闭防火墙: `systemctl stop firewalld.service`

3.访问: ip:{默认端口3000}  
默认用户名密码: admin/admin

### 🚁 Influxdb: 时序数据库

1.安装: `sudo yum install -y`，具体路径待补充

2.后台运行服务: `influxd &`

3.进入数据库: `influx`  

```sql
CREATE DATABASE jmeter;
show databases;
use jmeter;
show measurements;  # 类似show tables
```

### 🚁 使用后端监听器将执行数据写入Influxdb

## 📌 面试题

### 🚁 接口响应慢怎么办

1. **分析原因**：复现问题，详细分析对应接口性能瓶颈，如排查是否存在上下游依赖、涉及静态资源使用CDN加快访问速度。
2. **日志和监控分析**：通过日志和监控工具如 Prometheus、Grafana 等，确认根因。
3. **优化代码与算法**：检查是否有可优化的算法或多余的计算。
4. **数据库优化**：检查是否有数据库性能瓶颈，如索引、SQL优化等。
5. **缓存机制**：针对不频繁变动的数据，采用缓存机制，减少数据库查询次数。
6. **系统架构调整**：根据需求适当引入异步处理、消息队列、多线程多进程提高处理速度。
7. **硬件和网络**：检查服务器硬件性能、网络带宽是否满足要求。
 
---




